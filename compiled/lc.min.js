var LightningChat={devMode:false,sessionKey:false,apiBase:"",interfaceResources:{},messages:[],status:null,init:function(callback){LightningChat.sessionKey=LightningChat.getCookie("lcskey");LightningChat.getSession(this.sessionKey,function(result){if(!result)LightningChat.newSession(function(result){LightningChat.init(callback);});else{console.log("LightningChat initialized, session key -> "+LightningChat.sessionKey);LightningChat.messages=result;console.log(result);LightningChat.onMessageLoaded(result);LightningChat.beginHeartBeat();LightningChat.beginCheckInterval();callback();}});},onMessageLoaded:function(messages){},onNewMessage:function(new_message){},onStatusChange:function(stat){},beginCheckInterval:function(){setInterval(function(){LightningChat.ajax.get(LightningChat.apiBase+"/sessions/"+LightningChat.sessionKey,{},function(data){try{data=JSON.parse(data);}catch(e){console.log("Failed to parse response (checkInterval)");return;}if(data.status&&data.status=="notfound")console.log("Session key not found (checkInterval)");else{for(i=data.length-(data.length-LightningChat.messages.length);i<data.length;i++)LightningChat.onNewMessage(data[i]);LightningChat.messages=data;}});LightningChat.ajax.get(LightningChat.apiBase+"/sessions/"+LightningChat.sessionKey+"/info",{},function(data){try{data=JSON.parse(data);}catch(e){console.log("Failed to parse response (checkInterval-info)");return;}if(data.status&&data.status=="notfound")console.log("Session key not found (checkInterval-info)");else{if(LightningChat.status!=data.status)LightningChat.onStatusChange(data.status);LightningChat.status=data.status;}});},2000);},loadSessionEmail:function(callback){LightningChat.ajax.get(LightningChat.apiBase+"/sessions/"+LightningChat.sessionKey+"/info",{},function(data){try{data=JSON.parse(data);}catch(e){callback(false);return;}if(data.status&&data.status=="notfound")callback(false);else if(data.email=="none")callback(false);else{console.log(data);callback(data.email);}});},setSessionEmail:function(email,callback){LightningChat.ajax.post(LightningChat.apiBase+"/sessions/"+LightningChat.sessionKey+"/email",{email:email},function(data){try{data=JSON.parse(data);}catch(e){callback(false);return;}if(data.status&&data.status!="ok")callback(false);else callback(true);});},validateEmail:function(email){var re=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(email);},sendMessage:function(message,callback){LightningChat.ajax.post(LightningChat.apiBase+"/sessions/"+LightningChat.sessionKey,{message:message},function(data){try{data=JSON.parse(data);}catch(e){callback(false);return;}if(data.status&&data.status!="ok")callback(false);else callback(true);});},beginHeartBeat:function(){setInterval(function(){LightningChat.ajax.get(LightningChat.apiBase+"/sessions/"+LightningChat.sessionKey+"/heartbeat",{},function(){console.log("Heartbeat finished at "+new Date());});},5000);},getCookie:function(cname){var name=cname+"=";var decodedCookie=decodeURIComponent(document.cookie);var ca=decodedCookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1);if(c.indexOf(name)==0)return c.substring(name.length,c.length);}return false;},getSession:function(sessionKey,callback){this.ajax.get(this.apiBase+"/sessions/"+sessionKey,{},function(data){try{data=JSON.parse(data);}catch(e){callback(false);return;}if(data.status&&data.status=="notfound")callback(false);else callback(data);});},newSession:function(callback){LightningChat.ajax.post(LightningChat.apiBase+"/sessions",{},function(data){try{data=JSON.parse(data);}catch(e){callback(false);return;}LightningChat.setCookie("lcskey",data.session_id,365);callback(true);});},setCookie:function(cname,cvalue,exdays){var d=new Date();d.setTime(d.getTime()+(exdays*24*60*60*1000));var expires="expires="+d.toUTCString();document.cookie=cname+"="+cvalue+";"+expires+";path=/";},dom:{id:function(name){return document.getElementById(name);},lightningId:function(name){return new LightningChat.LightningDomObject(document.getElementById(name));},tag:function(name){return document.getElementsByTagName(name);},removeClass:function(dom,name){dom.classList.remove(name);},addClass:function(dom,name){dom.className+=' '+name;},toggleClass:function(dom,name){if(LightningChat.dom.hasClass(dom,name))LightningChat.dom.removeClass(dom,name);else LightningChat.dom.addClass(dom,name);},hasClass:function(dom,name){return(' '+dom.className+' ').indexOf(' '+name+' ')>-1;}},LightningDomObject:function(dom){this.dom=dom;this.addClass=function(name){this.dom.className+=' '+name;if(this.hasClass(name))this.removeClass(name);else this.addClass(name);return this;};this.toggleClass=function(name){return this;};this.hasClass=function(name){return(' '+this.dom.className+' ').indexOf(' '+name+' ')>-1;};this.removeClass=function(name){this.dom.classList.remove(name);return this;};this.setContent=function(content){this.dom.innerHTML=content;return this;};this.appendContent=function(content){this.dom.innerHTML+=content;};},ajax:{x:function(){if(typeof XMLHttpRequest!=='undefined')return new XMLHttpRequest();var versions=["MSXML2.XmlHttp.6.0","MSXML2.XmlHttp.5.0","MSXML2.XmlHttp.4.0","MSXML2.XmlHttp.3.0","MSXML2.XmlHttp.2.0","Microsoft.XmlHttp"];var xhr;for(var i=0;i<versions.length;i++)try{xhr=new ActiveXObject(versions[i]);break;}catch(e){}return xhr;},send:function(url,callback,method,data,async){if(async===undefined)async=true;var x=LightningChat.ajax.x();x.open(method,url,async);x.onreadystatechange=function(){if(x.readyState==4)callback(x.responseText);};if(method=='POST')x.setRequestHeader('Content-type','application/json');x.send(data);},get:function(url,data,callback,async){var query=[];for(var key in data)query.push(encodeURIComponent(key)+'='+encodeURIComponent(data[key]));LightningChat.ajax.send(url+(query.length?'?'+query.join('&'):''),callback,'GET',null,async);},post:function(url,data,callback,async){LightningChat.ajax.send(url,callback,'POST',JSON.stringify(data),async);}}};
LightningChat.apiBase = "http://localhost:3000";
LightningChat.interfaceResources = {
    htmlPath:"ui.html",
    welcomeMessage: "Welcome to AMACSS at UTSC, how can we help?",
    emailMessage: "What is you email address? if you are away, you will recieve an email notification when we reply."
};
function lightningChatLoadJS(url){var el=document.createElement('script');el.async=false;el.src=url;el.type='text/javascript';(document.getElementsByTagName('HEAD')[0]||document.body).appendChild(el);}function lightningChatLoadLESS(url){var el=document.createElement('link');el.async=false;el.href=url;el.type='text/less';el.rel='stylesheet';(document.getElementsByTagName('HEAD')[0]||document.body).appendChild(el);}function lightningChatLoadCSS(url){var el=document.createElement('link');el.async=false;el.href=url;el.type='text/css';el.rel='stylesheet';(document.getElementsByTagName('HEAD')[0]||document.body).appendChild(el);}
LightningChat.devMode=false;document.body.innerHTML+='<link href="https://ssl.jackzh.com/file/css/font-awesome-4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />';LightningChat.ajax.get(LightningChat.interfaceResources.htmlPath,{},function(data){document.body.innerHTML+=data;LightningChat.dom.lightningId("lightning-chat-welcome-message").setContent(LightningChat.interfaceResources.welcomeMessage);LightningChat.dom.lightningId("lightning-chat-email-message").setContent(LightningChat.interfaceResources.emailMessage);lightningChatInitialize();});if(LightningChat.devMode){lightningChatLoadLESS("style.less");lightningChatLoadJS("https://ssl.jackzh.com/file/js/less-js/less.min.js");}else lightningChatLoadCSS("style.css");function lightningChatInitialize(){LightningChat.init(function(){reloadSessionEmail();});function reloadSessionEmail(){LightningChat.loadSessionEmail(function(email){if(!email){LightningChat.dom.removeClass(LightningChat.dom.id("lightning-chat-email-form"),"lightning-chat-hidden");LightningChat.dom.addClass(LightningChat.dom.id("lightning-chat-email-status"),"lightning-chat-hidden");}else{LightningChat.dom.addClass(LightningChat.dom.id("lightning-chat-email-form"),"lightning-chat-hidden");LightningChat.dom.removeClass(LightningChat.dom.id("lightning-chat-email-status"),"lightning-chat-hidden");LightningChat.dom.id("lightning-chat-email-status-label").innerHTML="Hi! "+email;}});}LightningChat.dom.id("new-chat-controls").onclick=function(){LightningChat.setCookie("lcskey","",-1);LightningChat.init(function(){reloadSessionEmail();});};LightningChat.dom.id("lightning-chat-email-box").onblur=function(){if(LightningChat.validateEmail(LightningChat.dom.id("lightning-chat-email-box").value)){LightningChat.dom.removeClass(LightningChat.dom.id("lightning-chat-email-box"),"error");LightningChat.dom.id("lightning-chat-email-box").disabled=true;LightningChat.setSessionEmail(LightningChat.dom.id("lightning-chat-email-box").value,function(result){if(result){LightningChat.dom.id("lightning-chat-email-box").value="";reloadSessionEmail();}else{LightningChat.dom.id("lightning-chat-email-box").disabled=false;LightningChat.dom.addClass(LightningChat.dom.id("lightning-chat-email-box"),"error");}});}else LightningChat.dom.addClass(LightningChat.dom.id("lightning-chat-email-box"),"error");};LightningChat.onMessageLoaded=function(messages){LightningChat.dom.id("bubble-container").innerHTML="";for(i in messages){if(messages[i].sender=="visitor")var bubble_class="right-bubble";else var bubble_class="left-bubble";LightningChat.dom.id("bubble-container").innerHTML+="<div class='"+bubble_class+"'><p>"+messages[i].message+"</p></div>";}LightningChat.dom.id("bubble-container").scrollTo(0,LightningChat.dom.id("bubble-container").scrollHeight);};LightningChat.onNewMessage=function(message){if(message.sender=="visitor")var bubble_class="right-bubble";else var bubble_class="left-bubble";LightningChat.dom.id("bubble-container").innerHTML+="<div class='"+bubble_class+"'><p>"+message.message+"</p></div>";LightningChat.dom.id("bubble-container").scrollTo(0,LightningChat.dom.id("bubble-container").scrollHeight);};LightningChat.onStatusChange=function(stat){if(stat==0)LightningChat.dom.addClass(LightningChat.dom.id("lightning-chat-container"),"closed");else LightningChat.dom.removeClass(LightningChat.dom.id("lightning-chat-container"),"closed");};LightningChat.dom.id("lighting-message-area").onkeyup=function(e){if(e.keyCode==13)if(LightningChat.dom.id("lighting-message-area").value!=""){var message=LightningChat.dom.id("lighting-message-area").value;LightningChat.dom.id("lighting-message-area").value="";LightningChat.sendMessage(message,function(result){if(!result)alert("failed to send message");});}};LightningChat.dom.id("lightning-chat-begin-chat-button").onclick=function(){LightningChat.dom.toggleClass(LightningChat.dom.id("lightning-chat-content-container"),"not-shown");LightningChat.dom.toggleClass(LightningChat.dom.id("lightning-chat-begin-chat-button"),"active");};}